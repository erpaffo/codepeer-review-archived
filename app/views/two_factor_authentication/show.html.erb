<h1>Two-Factor Authentication</h1>

<p>Choose your preferred method of two-factor authentication:</p>

<%= form_with url: send_otp_two_factor_authentication_path, method: :post, local: true do |form| %>
  <p>
    <%= label_tag :two_factor_method, "Choose method" %><br>
    <%= select_tag :two_factor_method, options_for_select(@available_methods.map { |method| [method.capitalize, method] }), id: "two_factor_method" %>
  </p>
  <div id="phone_number_field" style="display: none;">
    <%= label_tag :phone_number, "Enter your phone number" %><br>
    <%= text_field_tag :phone_number %>
  </div>
  <p>
    <%= submit_tag "Send OTP" %>
  </p>
<% end %>

<% @enabled_methods.each do |method| %>
  <p>
    Two-factor authentication via <%= method.capitalize %> is enabled.
    <%= form_with url: disable_two_factor_authentication_path, method: :post, local: true do %>
      <%= hidden_field_tag :two_factor_method, method %>
      <%= submit_tag "Disable #{method.capitalize} 2FA" %>
    <% end %>
  </p>
<% end %>

<% if params[:two_factor_method] == 'app' && @qr_code %>
  <p>
    <%= image_tag @qr_code.to_data_url, alt: 'QR Code for Google Authenticator' %>
  </p>
  <p>
    After scanning, enter the OTP generated by your app.
    <%= form_with url: two_factor_authentication_verify_otp_path, method: :post, local: true do %>
      <%= hidden_field_tag :two_factor_method, 'app' %>
      <p>
        <%= label_tag :otp_code, "Enter the OTP code" %><br>
        <%= text_field_tag :otp_code %>
      </p>
      <p>
        <%= submit_tag "Verify OTP" %>
      </p>
    <% end %>
  </p>
<% end %>

<% if flash[:alert] %>
  <div class="alert"><%= flash[:alert] %></div>
<% end %>
<% if flash[:notice] %>
  <div class="notice"><%= flash[:notice] %></div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const methodSelect = document.getElementById('two_factor_method');
    const phoneNumberField = document.getElementById('phone_number_field');

    methodSelect.addEventListener('change', (event) => {
      const selectedMethod = event.target.value;
      if (selectedMethod === 'sms') {
        phoneNumberField.style.display = 'block';
      } else {
        phoneNumberField.style.display = 'none';
      }
    });

    // Trigger change event to set initial visibility
    methodSelect.dispatchEvent(new Event('change'));
  });
</script>
